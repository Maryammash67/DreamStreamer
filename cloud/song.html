<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
		crossorigin="anonymous"></script>



	<link rel="stylesheet" href="admin.css">





	<title>DreamStreamer</title>
</head>

<body>


	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="admin.html" class="brand">
			<i class='bx bxs-music' style="color:black;"></i>
			<span class="text" style="color:black;">DreamStreamer</span>
		</a>
		<ul class="side-menu top" style="padding-left: 1px;">
			<li>
				<a href="admin.html">
					<i class='bx bxs-dashboard'></i>
					<span class="text">Dashboard</span>
				</a>
			</li>

			<li>
				<a href="musicmanagment.html">
					<i class='bx bx-user'></i>
					<span class="text">Music Managment</span>
				</a>
			</li>

			<li class="active">
				<a href="song.html">
					<i class='bx bx-user'></i>
					<span class="text">Song Managment</span>
				</a>
			</li>
            <li>
				<a href="purchase.html">
					<i class='bx bx-user'></i>
					<span class="text">Purchase Managment</span>

				</a>
			</li>
		

		</ul>
		<ul class="side-menu" style="padding-left: 1px;">
			<li>
				<a href="">
					<i class='bx bxs-cog'></i>
					<span class="text">Settings</span>
				</a>
			</li>
			<li class="nav-item">
                <a href="https://dreamstemmer.auth.us-east-1.amazoncognito.com/logout?client_id=79dmdomhmdllqggccvgh7j7q5n&logout_uri=http%3A%2F%2Flocalhost%3A5500%2Findex.html" class="nav-link logout" onclick="confirmLogout()">
					<i class='bx bxs-log-out-circle'></i>
					<span class="text">Logout</span>
				</a>
				<form id="logout-form" action="" method="POST" class="d-none">

				</form>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->



	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu'></i>
			<a href="" class="nav-link">Dashboard</a>
			<form action="">

			</form>
			<input type="checkbox" id="switch-mode" hidden>
			<label for="switch-mode" class="switch-mode"></label>
			<a href="" class="notification">
				<i class='bx bxs-message'></i>
				<span class="num">3</span>
			</a>
			<a href="" class="profile">
				<img src="https://static.vecteezy.com/system/resources/previews/007/296/443/original/user-icon-person-icon-client-symbol-profile-icon-vector.jpg"
					alt="user-im">
			</a>
		</nav>
		<!-- end of NAVBAR -->

		<!-- MAIN -->
		<!-- MAIN -->
		<main>
			<div class="head-title">
				<div class="left">
					<h1>Dashboard</h1>
					<ul class="breadcrumb">
						<li>
							<a href="">Dashboard</a>
						</li>
						<li><i class='bx bx-chevron-right'></i></li>
						<li>
							<a class="active" href="admin.html">Home</a>
						</li>
						<li><i class='bx bx-chevron-right'></i></li>
						<li>
							<a class="active" href="musicmanagment.html">Music Managment</a>
						</li>
					
					</ul>
				</div>

			</div>
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSongModal">
				Add Song
			</button>
			
			<!-- Add Song Modal -->
			<div class="modal fade" id="addSongModal" tabindex="-1" aria-labelledby="addSongModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="addSongModalLabel">Add Song</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<!-- Add Song Form -->
							<form id="addSongForm">
								<div class="mb-3">
									<label for="albumSelect" class="form-label">Select Album</label>
									<select class="form-select" id="albumSelect" required>
										<!-- Album options will be populated by JavaScript -->
									</select>
								</div>
								<div class="mb-3">
									<label for="songName" class="form-label">Song Name</label>
									<input type="text" class="form-control" id="songName" placeholder="Enter song name" required>
								</div>
								<div class="mb-3">
									<label for="songFile" class="form-label">Upload Song</label>
									<input class="form-control" type="file" id="songFile" accept="audio/*" required>
								</div>
								<button type="submit" class="btn btn-primary">Upload Song</button>
							</form>
						</div>
					</div>
				</div>
			</div>

        
			<div class="table-data">
				<div class="order">
					<div class="head">
						<h3>Musics</h3>

						
							



					</div>
					<div class="table-container">
						<table>
							<thead>
								<tr>
									<th>Song Name</th>
									<th>Album Name</th>
									<th>Artist Name</th>
									<th>Genre</th>

									<th>Song </th>
									<th></th> <!-- For Update button -->
									<th></th> <!-- For Delete button -->
								</tr>
							</thead>
							<tbody id="songTableBody">
							</tbody>
						</table>
					</div>
					<!-- 
				<h2>View Albums</h2>
				<div class="album-container" id="albumContainer"></div> -->

				</div>
		</main>
	</section>
	<!-- CONTENT -->


    <!-- Edit song modal -->

    <!-- Modal for Editing Songs -->
<!-- <div class="modal fade" id="editSongModal" tabindex="-1" aria-labelledby="editSongModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSongModalLabel">Edit Song</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSongForm">
                    <input type="hidden" id="songIdEdit" name="songIdEdit">

                    
                    <div class="mb-3">
                        <label for="songNameEdit" class="form-label">Song Name</label>
                        <input type="text" class="form-control" id="songNameEdit" required>
                    </div>

                    
                    <div class="mb-3">
                        <label for="albumSelectEdit" class="form-label">Select Album</label>
                        <select class="form-select" id="albumSelectEdit" required>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div> -->
<!-- Edit Song Modal -->
<div class="modal fade" id="editSongModal" tabindex="-1" aria-labelledby="editSongModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSongModalLabel">Edit Song</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSongForm">
                    <!-- Hidden input to store song ID -->
                    <input type="hidden" id="editSongId">
                    
                    <!-- Song Name -->
                    <div class="mb-3">
                        <label for="editSongName" class="form-label">Song Name</label>
                        <input type="text" class="form-control" id="editSongName" required>
                    </div>

                    <!-- Album Select Dropdown -->
                    <div class="mb-3">
                        <label for="editAlbumSelect" class="form-label">Select Album</label>
                        <select class="form-control" id="editAlbumSelect" required></select>
                    </div>

                    <!-- Existing Song Player -->
                    <div class="mb-3">
                        <label for="existingSong" class="form-label">Current Song</label>
                        <audio id="existingSongPlayer" controls>
                            <source id="existingSongSource" src="" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>

                    <!-- Upload New Song (Optional) -->
                    <div class="mb-3">
                        <label for="editSongFile" class="form-label">Upload New Song (Optional)</label>
                        <input type="file" class="form-control" id="editSongFile" accept=".mp3">
                    </div>

                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Script for PUT Song -->
<script>
		
		document.addEventListener('DOMContentLoaded', function () {
    const albumSelect = document.getElementById('albumSelect');

    // Function to fetch albums from API and populate the dropdown
    function fetchAlbums() {
        const albumApiUrl = 'https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/album';

        fetch(albumApiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data); // Log the response for debugging

                if (data.length > 0) {
                    albumSelect.innerHTML = ''; // Clear existing options
                    data.forEach(album => {
                        const option = document.createElement('option');
                        option.value = album.album_id;  // Use album_id instead of album_name
                        option.textContent = album.AlbumName || album.Artists;  // Display album name or artist
                        albumSelect.appendChild(option);
                    });
                } else {
                    console.error('No albums found in the response.');
                    albumSelect.innerHTML = '<option disabled>No albums available</option>';
                }
            })
            .catch(error => console.error('Error fetching albums:', error));
    }

    // Populate albums when the modal is shown
    const addSongModal = document.getElementById('addSongModal');
    addSongModal.addEventListener('show.bs.modal', fetchAlbums);

    // Handle song form submission
    const addSongForm = document.getElementById('addSongForm');
    addSongForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const albumId = albumSelect.value;  // Send album_id instead of album_name
        const songName = document.getElementById('songName').value;
        const songFile = document.getElementById('songFile').files[0];

        if (!albumId || !songName || !songFile) {
            alert('Please fill all fields.');
            return;
        }

        // Convert song file to Base64
        const reader = new FileReader();
        reader.readAsDataURL(songFile);
        reader.onloadend = function () {
            const base64SongData = reader.result.split(',')[1]; // Extract Base64 part

            const requestBody = {
                album_id: albumId,  // Send album_id to Lambda
                songs: [
                    {
                        song_name: songName,
                        song_data: base64SongData,
                    },
                ],
            };
            console.log('Request Body:', requestBody);

            // Call the Lambda function to upload song
            fetch('https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/songs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            })
           .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('API Response:', data); // Log the response
                if (data.message) {
                    alert('Song uploaded successfully!');
                } else {
                    alert('Failed to upload song. Check response for errors.');
                }
            })
            .catch(error => {
                console.error('Error uploading song:', error);
                alert('Failed to upload song. Please try again.');
            });
        };

        reader.onerror = function () {
            console.error('File reading failed.');
            alert('Failed to read song file.');
        };
    });
});

	
</script>

<!-- Script for calling GET Song -->
<script>
	window.onload = function () {
		fetchSongs();
	};
</script>

<!-- script for GET and DELETE function -->
<script>
    function fetchSongs() {
        fetch('https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/songs', {
            method: 'GET'
        })
        .then(response => response.json())
        .then(songs => {
            console.log('Songs data:', songs); // Log the song data to the console

            const songTableBody = document.getElementById('songTableBody');
            songTableBody.innerHTML = '';  // Clear previous table rows

            // Loop through the fetched songs
            songs.forEach(song => {
                const songRow = document.createElement('tr');

                // Song Name
                const songNameCell = document.createElement('td');
                songNameCell.innerText = song.song_name;  // Fallback if song_name is missing
                songRow.appendChild(songNameCell);

                // Album Name
                const albumNameCell = document.createElement('td');
                albumNameCell.innerText = song.AlbumName;  // Fallback if AlbumName is missing
                songRow.appendChild(albumNameCell);

                // Artist(s)
                const artistsCell = document.createElement('td');
                artistsCell.innerText = song.Artists;  // Join artists with a comma
                songRow.appendChild(artistsCell);

                // Genre
                const genreCell = document.createElement('td');
                genreCell.innerText = song.Genre;  // Fallback if Genre is missing
                songRow.appendChild(genreCell);

                // Song URL
                const songUrlCell = document.createElement('td');
                if (song.song_url) {
                    const songLink = document.createElement('a');
                    songLink.href = song.song_url;
                    songLink.innerText = 'Listen';
                    songLink.target = '_blank';  // Open song link in a new tab
                    songUrlCell.appendChild(songLink);
                } else {
                    songUrlCell.innerText = 'N/A';  // Fallback if song_url is missing
                }
                songRow.appendChild(songUrlCell);

                
                   // Update Button
                   const updateCell = document.createElement('td');
                   const updateButton = document.createElement('button');
                   updateButton.innerText = 'Update';
                   updateButton.onclick = () => openEditModal(song);  // Call the correct function
                   updateCell.appendChild(updateButton);
                   songRow.appendChild(updateCell);

                // Delete Button
                const deleteCell = document.createElement('td');
                        const deleteButton = document.createElement('button');
                        deleteButton.innerText = 'Delete';
                        deleteButton.onclick = () => {
                       if (confirm('Are you sure you want to delete this song?')) {
                        deleteSong(song.song_id);  // Calls the deleteAlbum function
                        }
                    };
                    deleteCell.appendChild(deleteButton);
                    songRow.appendChild(deleteCell);


						// Append the row to the table body
						songTableBody.appendChild(songRow);
					});
				})
				.catch(error => {
					console.error('Error fetching songs:', error);
				});

				 // Delete an album
				 function deleteSong(song_id) {
        fetch(`https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/songs`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ song_id: song_id })  // Passing the album_id to the delete request
        })
        .then(response => {
            if (response.ok) {
                alert('Song deleted successfully!');
                fetchSongs();  // Refresh the table after deletion
            } else {
                alert('Failed to delete song.');
            }
        })
        .catch(error => {
            console.error('Error deleting song:', error);
        });
    }

    // Call fetchAlbums on page load to populate the table
    document.addEventListener('DOMContentLoaded', fetchSongs);

		}

    // Call fetchSongs to load songs when the page loads
   // fetchSongs();


</script>

<!-- <script>
    function openUpdateModal(song) {
    // Set the modal input fields with the current song details
    document.getElementById('songNameEdit').value = song.song_name;  // Pre-fill song name
    document.getElementById('albumSelectEdit').value = song.album_id;  // Pre-select current album

    // Save the song ID for the update
    document.getElementById('songIdEdit').value = song.song_id;

    // Show the modal
    const editModal = new bootstrap.Modal(document.getElementById('editSongModal'));
    editModal.show();
}


document.addEventListener('DOMContentLoaded', function () {
    const albumSelectEdit = document.getElementById('albumSelectEdit');

    // Function to fetch albums from API and populate the dropdown
    function fetchAlbums() {
        const albumApiUrl = 'https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/album';

        fetch(albumApiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data); // Log the response for debugging

                if (data.length > 0) {
                    albumSelectEdit.innerHTML = ''; // Clear existing options
                    data.forEach(album => {
                        const option = document.createElement('option');
                        option.value = album.album_id;  // Use album_id instead of album_name
                        option.textContent = album.AlbumName || album.Artists;  // Display album name or artist
                        albumSelectEdit.appendChild(option);
                    });
                } else {
                    console.error('No albums found in the response.');
                    albumSelectEdit.innerHTML = '<option disabled>No albums available</option>';
                }
            })
            .catch(error => console.error('Error fetching albums:', error));
    }

    // Populate albums when the modal is shown
    const editSongModal = document.getElementById('editSongModal');
    editSongModal.addEventListener('show.bs.modal', fetchAlbums);
});

document.addEventListener('DOMContentLoaded', function () {
    const editSongForm = document.getElementById('editSongForm');

    editSongForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const songId = document.getElementById('songIdEdit').value;  // Song ID to update
        const albumId = document.getElementById('albumSelectEdit').value;  // Selected album ID
        const songName = document.getElementById('songNameEdit').value;  // Updated song name

        if (!albumId || !songName) {
            alert('Please fill all fields.');
            return;
        }

        const requestBody = {
            song_id: songId,
            album_id: albumId,  // Send album_id to Lambda
            song_name: songName
        };
        console.log('Edit Request Body:', requestBody);

        // Call the Lambda function to update the song
        fetch('https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/songs', {
            method: 'PUT',  // Update existing song
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);  // Log the response
            if (data.message) {
                alert('Song updated successfully!');
                fetchSongs();  // Refresh the song list
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editSongModal'));
                editModal.hide();  // Hide the modal after successful update
            } else {
                alert('Failed to update song. Check response for errors.');
            }
        })
        .catch(error => {
            console.error('Error updating song:', error);
            alert('Failed to update song. Please try again.');
        });
    });
});

</script> -->
	
<script>

    // Function to fetch albums and populate the dropdown
function fetchAlbums() {
    const albumSelect = document.getElementById('editAlbumSelect');  // Make sure this matches your dropdown ID
    const albumApiUrl = 'https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/album';  // Replace with your album API URL

    fetch(albumApiUrl)
        .then(response => response.json())
        .then(data => {
            console.log('API Response:', data);  // Log the response for debugging

            if (data.length > 0) {
                albumSelect.innerHTML = '';  // Clear existing options
                data.forEach(album => {
                    const option = document.createElement('option');
                    option.value = album.album_id;  // Use album_id for the value
                    option.textContent = album.AlbumName || album.Artists;  // Show album name or artist
                    albumSelect.appendChild(option);
                });
            } else {
                console.error('No albums found in the response.');
                albumSelect.innerHTML = '<option disabled>No albums available</option>';
            }
        })
        .catch(error => console.error('Error fetching albums:', error));
}

    // Open modal with pre-filled details
    function openEditModal(song) {
        // Set the existing song data in the modal fields
        document.getElementById('editSongId').value = song.song_id;
        document.getElementById('editSongName').value = song.song_name;

        // Load existing album in the dropdown
        const albumSelect = document.getElementById('editAlbumSelect');
        fetchAlbums();  // Reuse your fetchAlbums function to populate the dropdown

        // Load the existing song in the audio player
        const songPlayer = document.getElementById('existingSongPlayer');
        const songSource = document.getElementById('existingSongSource');
        if (song.song_url) {
            songSource.src = song.song_url;  // Set the song URL for the player
            songPlayer.load();  // Reload the audio player with the new source
        }

        // Open the modal
        const editSongModal = new bootstrap.Modal(document.getElementById('editSongModal'));
        editSongModal.show();
    }

    // Handle the form submission for editing the song
    document.getElementById('editSongForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const songId = document.getElementById('editSongId').value;
        const songName = document.getElementById('editSongName').value;
        const albumId = document.getElementById('editAlbumSelect').value;
        const newSongFile = document.getElementById('editSongFile').files[0];  // Optional new file upload

        // Prepare request body
        const requestBody = {
            song_id: songId,
            album_id: albumId,
            song_name: songName,
            replace_song: false  // Default to not replacing the song file
        };

        // If a new song file is uploaded, convert it to Base64 and update the request body
        if (newSongFile) {
            const reader = new FileReader();
            reader.readAsDataURL(newSongFile);
            reader.onloadend = function () {
                const base64SongData = reader.result.split(',')[1];  // Extract Base64 part
                requestBody.replace_song = true;  // Set flag to replace the song
                requestBody.song_data = base64SongData;  // Attach new song data
                sendEditRequest(requestBody);  // Send request after file is processed
            };
        } else {
            sendEditRequest(requestBody);  // Send request immediately if no new song is uploaded
        }
    });

    // Function to send edit request to Lambda
    function sendEditRequest(requestBody) {
        fetch('https://ce6gjpszo8.execute-api.us-east-1.amazonaws.com/admin/songs', {
            method: 'PUT',  // Use PATCH for updating
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            if (data.message) {
                alert('Song updated successfully!');
                // Refresh the song list or close the modal
                fetchSongs();  // Reload the song list
                document.getElementById('editSongModal').modal('hide');  // Close the modal
            } else {
                alert('Failed to update song. Check response for errors.');
            }
        })
        .catch(error => {
            console.error('Error updating song:', error);
            alert('Failed to update song. Please try again.');
        });
    }

    
</script>



	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- <script src="admin.js"></script> -->


</body>

</html>